name: Build and Deploy

on:
  workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2
      with:
        ref: dev

    - name: Update Build Number
      run: |
        LATEST_BUILD_NUM=${{ github.run_number }}
        sed -i "s/Latest Build number:.*<\/p>/Latest Build number: $LATEST_BUILD_NUM<\/p>/g" web/index.html
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        git add web/index.html
        git commit -m "Update build number to $LATEST_BUILD_NUM"
        git push origin dev
      env:
        GITHUB_TOKEN: ${{ secrets.DD_token }}

    - name: Create Artifact
      uses: actions/upload-artifact@v2
      with:
        name: updated-html
        path: web/index.html

  deploy:
    needs: build

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
